# .github/workflows/release.yml
name: Release (PyPI + GitHub Release + Zenodo DOI)

on:
  push:
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Build + check
        run: |
          python -m pip install -U pip build twine
          python -m build
          python -m twine check dist/*

      - name: Upload to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: python -m twine upload dist/*

      - name: Create GitHub Release (attach dist/*)
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Zenodo (print DOI)
        env:
          ZENODO_ACCESS_TOKEN: ${{ secrets.ZENODO_API_TOKEN }}
          ZENODO_SANDBOX: "false" # set "true" for sandbox.zenodo.org
        shell: bash
        run: |
          set -euo pipefail
          API="https://zenodo.org/api"; [[ "$ZENODO_SANDBOX" == "true" ]] && API="https://sandbox.zenodo.org/api"

          dep="$(curl -sS -X POST "$API/deposit/depositions" -H "Authorization: Bearer $ZENODO_ACCESS_TOKEN" -H "Content-Type: application/json" -d '{}')"
          id="$(python -c "import json,sys; print(json.loads(sys.argv[1])['id'])" "$dep")"
          bucket="$(python -c "import json,sys; print(json.loads(sys.argv[1])['links']['bucket'])" "$dep")"

          for f in dist/*; do
            curl -sS -X PUT "$bucket/$(basename "$f")" -H "Authorization: Bearer $ZENODO_ACCESS_TOKEN" --upload-file "$f" >/dev/null
          done

          pub="$(curl -sS -X POST "$API/deposit/depositions/$id/actions/publish" -H "Authorization: Bearer $ZENODO_ACCESS_TOKEN")"
          python - <<'PY'
          import json,sys
          j=json.loads(sys.stdin.read())
          doi=j.get("doi") or j.get("metadata",{}).get("doi") or j.get("metadata",{}).get("prereserve_doi",{}).get("doi")
          url=j.get("links",{}).get("html") or j.get("record_url")
          print("Zenodo published")
          if doi: print("DOI:", doi)
          if url: print("Record:", url)
          PY <<<"$pub"
